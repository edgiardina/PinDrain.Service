<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PinDrain Calibrate</title>
  <style>
    :root { --bg:#111; --fg:#eee; --accent:#1e88e5; --muted:#263238; --border:#3a3a3a; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui, sans-serif; }
    #tabs { position:sticky; top:0; z-index:5; display:flex; gap:8px; padding:10px 12px; background:rgba(17,17,17,.95); backdrop-filter: blur(4px); border-bottom:1px solid var(--border); }
    #tabs button { background:var(--muted); color:var(--fg); border:1px solid var(--border); border-radius:6px; padding:6px 10px; cursor:pointer; }
    #tabs button.active { background:var(--accent); border-color:var(--accent); }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; padding:10px 12px; }
    .toolbar label { display:flex; gap:6px; align-items:center; }
    .toolbar input, .toolbar select { padding:6px 8px; border-radius:6px; border:1px solid #444; background:#222; color:var(--fg); }
    .toolbar button { background:var(--accent); color:white; border:0; padding:8px 12px; border-radius:6px; cursor:pointer; }
    #paneQuad { display:block; }
    #stage { position: relative; display:inline-block; margin: 0 12px 12px; }
    #feed, #cal { position:absolute; top:0; left:0; }
    #feed { background:#000; }
    #roiPane { display:none; }
    #roiToolbar { position:sticky; top:48px; z-index:4; display:flex; gap:8px; align-items:center; padding:10px 12px; background:rgba(17,17,17,.95); border-bottom:1px solid var(--border); }
    #roiWrap { height: calc(100vh - 140px); overflow:auto; padding:12px; }
    #roiCanvas { width: 400px; height: 800px; background:#000; border:1px solid #333; image-rendering: crisp-edges; image-rendering: pixelated; display:block; }
    #roiMsg { margin-left:8px; opacity:.85; }
    #screenHint { color:#b0bec5; font-size:.9em; }
    #serverSrc { border-top:1px solid var(--border); margin: 0 12px; padding:10px 0; }
    #serverSrc .group { display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:0 0 8px; }
    #serverSrc small { opacity:.8; }
    #livePane { display:none; }
    #liveStream { width: 100%; max-width: 500px; height: auto; border:1px solid #333; background:#000; }
    #liveWrap { padding: 12px; text-align: center; }
  </style>
</head>
<body>

  <div id="tabs">
    <button id="tabQuad" class="active">Camera Quad</button>
    <button id="tabRoi">ROIs</button>
    <button id="tabLive">Live Feed</button>
  </div>

  <div id="paneQuad">
    <div id="toolbar" class="toolbar">
      <label>Mode
        <select id="mode">
          <option value="camera">Camera</option>
          <option value="screen">Screen/Window</option>
          <option value="none">None</option>
        </select>
      </label>

      <label id="camWrap">Device
        <select id="device"></select>
      </label>

      <button id="pickBtn" hidden>Pick Window/Tab</button>
      <span id="screenHint" hidden>Browser will show a picker to select a screen/window/tab.</span>

      <input id="camId"   placeholder="Camera ID"  value="scene-1">
      <input id="camName" placeholder="Name"       value="DeskCam">
      <label><input type="checkbox" id="lockRect"> Keep rectangle</label>
      <button id="saveBtn">Save Camera Quad</button>
      <span id="msg"></span>
    </div>

    <div id="serverSrc">
      <div class="group">
        <strong>Detector Source</strong>
        <small>(server)</small>
        <label>Mode
          <select id="vidModeSel">
            <option value="device">Device</option>
            <option value="file">File</option>
            <option value="url">URL</option>
          </select>
        </label>
        <label id="vidDevWrap">Device Id <input id="vidDeviceId" type="number" min="0" step="1" style="width:90px"/></label>
        <label id="vidFileWrap" hidden>File Path <input id="vidFilePath" style="width:360px" placeholder="C:\\clips\\pinball.mp4"/></label>
        <label id="vidUrlWrap" hidden>Stream URL <input id="vidStreamUrl" style="width:360px" placeholder="rtsp://... or http(s)://..."/></label>
        <button id="vidSave">Save Video Settings</button>
        <span id="vidMsg"></span>
      </div>
      <div class="group">
        <small>Note: After saving, restart the app for the detector to pick up the new source.</small>
      </div>
    </div>

    <div id="stage">
      <video id="feed" autoplay playsinline muted></video>
      <canvas id="cal"></canvas>
    </div>
  </div>

  <div id="roiPane">
    <div id="roiToolbar" class="toolbar">
      <button id="snapBtn">Warp Snapshot</button>
      <select id="roiSelect">
        <option value="leftOutlane">Left Outlane</option>
        <option value="centerDrain">Center Drain</option>
        <option value="rightOutlane">Right Outlane</option>
      </select>
      <button id="roiClear">Clear</button>
      <input id="gameId" value="generic-pin" title="Game Id">
      <input id="gameName" value="Generic Pin" title="Game Name">
      <button id="saveGame">Save Game ROI</button>
      <button id="activate">Activate</button>
      <span id="roiMsg"></span>
    </div>
    <div id="roiWrap">
      <canvas id="roiCanvas" width="1000" height="2000"></canvas>
    </div>
  </div>

  <div id="livePane">
    <div id="liveWrap">
      <h3>Live Detector Feed</h3>
      <p>Real-time view of what the detector sees with ROI overlays and tracked objects.</p>
      <img id="liveStream" src="/api/debug/stream" alt="Live detector feed" />
      <p><small>Yellow dots = tracked objects, colored outlines = ROI boundaries</small></p>
    </div>
  </div>

  <script src="calibrate.js"></script>
</body>
</html>
